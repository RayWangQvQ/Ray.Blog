@using Ray.Blog.Posts
@using Ray.Blog.ThumbUps
@using Volo.Abp.Application.Dtos
@using Volo.Abp.Users

<Button Margin="Margin.Is2" Size="Size.Large" Border="@_thumbButtonBorder" Shadow="Shadow.Large" onclick="@OnThumbUpClicked">
    <Icon Name="IconName.ThumbsUp" TextColor="@_textColor" /> @this._thumbUpDtos.Count
</Button>

@code {
    [Parameter]
    public Guid SourceId { get; set; }

    [Inject]
    private IThumbUpAppService ThumbUpAppService { get; set; }

    [Inject]
    private ICurrentUser CurrentUser { get; set; }

    private IReadOnlyList<ThumbUpDto> _thumbUpDtos = new List<ThumbUpDto>();

    private IFluentBorderColorWithSide _thumbButtonBorder = Border.Is1.Rounded.Secondary;
    private TextColor _textColor = TextColor.Secondary;

    private bool _isThumbUped => _thumbUpDtos.Any(x => x.CreatorId == CurrentUser.Id);

    protected override async Task OnInitializedAsync()
    {
        await SetThumbUpDtos();

        if (_isThumbUped)
        {
            SetThumbUp();
        }
        else
        {
            SetUnThumbUp();
        }

        await base.OnInitializedAsync();
    }

    private async Task SetThumbUpDtos()
    {
        _thumbUpDtos = (await ThumbUpAppService.GetListAsync(new GetThumbUpListDto()
            {
                SourceId = this.SourceId,
                MaxResultCount = LimitedResultRequestDto.MaxMaxResultCount
            })).Items;
    }

    public async Task OnThumbUpClicked()
    {
        if (!_isThumbUped)
        {
            await ThumbUpAppService.CreateAsync(new ThumbUpDto() { SourceId = this.SourceId });
            SetThumbUp();
            await SetThumbUpDtos();
            return;
        }

        var id = _thumbUpDtos.FirstOrDefault(x => x.SourceId == this.SourceId && x.CreatorId == CurrentUser.Id)?.Id;
        if (id.HasValue)
        {
            await ThumbUpAppService.DeleteAsync(id.Value);
            SetUnThumbUp();
            await SetThumbUpDtos();
        }
    }

    private void SetUnThumbUp()
    {
        _thumbButtonBorder = Border.Is1.Rounded.Secondary;
        _textColor = TextColor.Secondary;
    }

    private void SetThumbUp()
    {
        _thumbButtonBorder = Border.Is1.Rounded.Success;
        _textColor = TextColor.Success;
    }
}
